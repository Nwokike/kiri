{% extends "base.html" %}

{% block title %}Universal Translator | Project 0{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">

    <!-- Header -->
    <header class="text-center space-y-4">
        <div
            class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-primary-900/30 border border-primary-800/50 text-primary-400 text-xs font-mono tracking-wider">
            <span class="w-2 h-2 bg-primary-500 rounded-full animate-pulse"></span>
            PROJECT_0 // FLAGSHIP_DEMO
        </div>
        <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight">
            Universal <span class="text-primary-400">Translator</span>
        </h1>
        <p class="text-zinc-400 max-w-xl mx-auto">
            Real-time, <strong class="text-white">client-side</strong> translation powered by Transformers.js.
            No data leaves your device. Speak or type in any language.
        </p>
    </header>

    <!-- Model Status -->
    <div id="model-status" class="glass-panel p-4 rounded-lg flex items-center justify-between border border-zinc-800">
        <div class="flex items-center gap-3">
            <div id="status-dot" class="w-3 h-3 rounded-full bg-yellow-500 animate-pulse"></div>
            <span id="status-text" class="text-sm text-zinc-400 font-mono">Initializing model...</span>
        </div>
        <div id="progress-container" class="w-48 h-2 bg-zinc-800 rounded-full overflow-hidden hidden">
            <div id="progress-bar" class="h-full bg-primary-500 transition-all duration-300" style="width: 0%"></div>
        </div>
    </div>

    <!-- Translation Interface -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Source -->
        <div class="glass-panel p-6 rounded-xl border border-zinc-800 space-y-4">
            <div class="flex items-center justify-between">
                <label class="text-sm font-bold text-zinc-300 flex items-center gap-2">
                    <i class="fas fa-microphone-alt text-zinc-500"></i> Source
                </label>
                <select id="source-lang"
                    class="bg-zinc-900 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300 focus:border-primary-500 outline-none">
                    <option value="en">English</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="es">Spanish</option>
                    <option value="zh">Chinese</option>
                    <option value="ar">Arabic</option>
                </select>
            </div>
            <textarea id="source-text" rows="6" placeholder="Enter text to translate or click the microphone..."
                class="w-full bg-zinc-900/50 border border-zinc-800 rounded-lg p-4 text-white placeholder-zinc-600 focus:border-primary-500 outline-none resize-none font-mono text-sm"></textarea>
            <div class="flex items-center gap-2">
                <button id="mic-btn"
                    class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-zinc-300 transition-colors flex items-center gap-2 text-sm disabled:opacity-50"
                    disabled>
                    <i class="fas fa-microphone"></i> Listen
                </button>
                <button id="clear-btn"
                    class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-zinc-300 transition-colors text-sm">
                    <i class="fas fa-eraser"></i>
                </button>
            </div>
        </div>

        <!-- Target -->
        <div class="glass-panel p-6 rounded-xl border border-zinc-800 space-y-4">
            <div class="flex items-center justify-between">
                <label class="text-sm font-bold text-zinc-300 flex items-center gap-2">
                    <i class="fas fa-language text-zinc-500"></i> Target
                </label>
                <select id="target-lang"
                    class="bg-zinc-900 border border-zinc-700 rounded px-2 py-1 text-xs text-zinc-300 focus:border-primary-500 outline-none">
                    <option value="fr">French</option>
                    <option value="en">English</option>
                    <option value="de">German</option>
                    <option value="es">Spanish</option>
                    <option value="zh">Chinese</option>
                    <option value="ar">Arabic</option>
                </select>
            </div>
            <div id="target-text"
                class="w-full h-36 bg-zinc-900/50 border border-zinc-800 rounded-lg p-4 text-primary-400 font-mono text-sm overflow-y-auto">
                <span class="text-zinc-600 italic">Translation will appear here...</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="speak-btn"
                    class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-zinc-300 transition-colors flex items-center gap-2 text-sm disabled:opacity-50"
                    disabled>
                    <i class="fas fa-volume-up"></i> Speak
                </button>
                <button id="copy-btn"
                    class="px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-zinc-300 transition-colors text-sm disabled:opacity-50"
                    disabled>
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Translate Button -->
    <div class="text-center">
        <button id="translate-btn"
            class="px-8 py-3 bg-primary-600 hover:bg-primary-500 text-white font-bold rounded-lg transition-all shadow-lg shadow-primary-900/50 disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
            <i class="fas fa-exchange-alt mr-2"></i> Translate
        </button>
    </div>

    <!-- Info Panel -->
    <div class="glass-panel p-6 rounded-xl border border-zinc-800 text-center space-y-2">
        <p class="text-zinc-500 text-xs font-mono">
            <i class="fas fa-shield-alt text-primary-500 mr-1"></i>
            All processing happens <strong class="text-white">locally in your browser</strong> using WebGPU/WASM.
        </p>
        <p class="text-zinc-600 text-xs">
            Powered by <a href="https://huggingface.co/docs/transformers.js" target="_blank" rel="noopener"
                class="text-primary-400 hover:underline">Transformers.js</a> (Xenova) &bull;
            Model: <code class="text-zinc-400">Xenova/nllb-200-distilled-600M</code>
        </p>
    </div>
</div>

<script type="module">
    import { pipeline, env } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

    // Disable local model caching to use CDN
    env.allowLocalModels = false;

    const statusDot = document.getElementById('status-dot');
    const statusText = document.getElementById('status-text');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const sourceText = document.getElementById('source-text');
    const targetText = document.getElementById('target-text');
    const sourceLang = document.getElementById('source-lang');
    const targetLang = document.getElementById('target-lang');
    const translateBtn = document.getElementById('translate-btn');
    const micBtn = document.getElementById('mic-btn');
    const speakBtn = document.getElementById('speak-btn');
    const copyBtn = document.getElementById('copy-btn');
    const clearBtn = document.getElementById('clear-btn');

    let translator = null;
    let recognition = null;
    let isListening = false;

    // NLLB language codes
    const nllbCodes = {
        en: 'eng_Latn',
        fr: 'fra_Latn',
        de: 'deu_Latn',
        es: 'spa_Latn',
        zh: 'zho_Hans',
        ar: 'arb_Arab'
    };

    // Initialize model
    async function initModel() {
        try {
            statusText.textContent = 'Loading translation model (first run may take 1-2 minutes)...';
            progressContainer.classList.remove('hidden');

            translator = await pipeline('translation', 'Xenova/nllb-200-distilled-600M', {
                progress_callback: (progress) => {
                    if (progress.status === 'progress') {
                        const pct = Math.round((progress.loaded / progress.total) * 100);
                        progressBar.style.width = pct + '%';
                        statusText.textContent = `Downloading model... ${pct}%`;
                    }
                }
            });

            statusDot.classList.remove('bg-yellow-500', 'animate-pulse');
            statusDot.classList.add('bg-green-500');
            statusText.textContent = 'Model ready. Translation is fully offline.';
            progressContainer.classList.add('hidden');

            translateBtn.disabled = false;
            micBtn.disabled = false;
            speakBtn.disabled = false;
            copyBtn.disabled = false;

        } catch (error) {
            statusDot.classList.remove('bg-yellow-500');
            statusDot.classList.add('bg-red-500');
            statusText.textContent = 'Error loading model: ' + error.message;
            console.error(error);
        }
    }

    // Translate
    async function translate() {
        const text = sourceText.value.trim();
        if (!text || !translator) return;

        translateBtn.disabled = true;
        translateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Translating...';

        try {
            const srcCode = nllbCodes[sourceLang.value];
            const tgtCode = nllbCodes[targetLang.value];

            const result = await translator(text, {
                src_lang: srcCode,
                tgt_lang: tgtCode
            });

            targetText.innerHTML = '';
            targetText.textContent = result[0].translation_text;

        } catch (error) {
            targetText.innerHTML = `<span class="text-red-400">Error: ${error.message}</span>`;
        } finally {
            translateBtn.disabled = false;
            translateBtn.innerHTML = '<i class="fas fa-exchange-alt mr-2"></i> Translate';
        }
    }

    // Speech Recognition (Web Speech API)
    function initSpeechRecognition() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            micBtn.title = 'Speech recognition not supported in this browser';
            return;
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = sourceLang.value;

        recognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0].transcript)
                .join('');
            sourceText.value = transcript;
        };

        recognition.onend = () => {
            isListening = false;
            micBtn.innerHTML = '<i class="fas fa-microphone"></i> Listen';
            micBtn.classList.remove('bg-red-600');
        };
    }

    function toggleMic() {
        if (!recognition) return;

        if (isListening) {
            recognition.stop();
        } else {
            recognition.lang = sourceLang.value;
            recognition.start();
            isListening = true;
            micBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
            micBtn.classList.add('bg-red-600');
        }
    }

    // Text-to-Speech
    function speak() {
        const text = targetText.textContent;
        if (!text || text.includes('Translation will appear')) return;

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = targetLang.value;
        speechSynthesis.speak(utterance);
    }

    // Copy
    function copyToClipboard() {
        const text = targetText.textContent;
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => copyBtn.innerHTML = '<i class="fas fa-copy"></i>', 1500);
        });
    }

    // Event listeners
    translateBtn.addEventListener('click', translate);
    micBtn.addEventListener('click', toggleMic);
    speakBtn.addEventListener('click', speak);
    copyBtn.addEventListener('click', copyToClipboard);
    clearBtn.addEventListener('click', () => {
        sourceText.value = '';
        targetText.innerHTML = '<span class="text-zinc-600 italic">Translation will appear here...</span>';
    });
    sourceText.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) translate();
    });

    // Initialize
    initModel();
    initSpeechRecognition();
</script>
{% endblock %}