{% extends "base.html" %}
{% load static %}
{% load core_tags %}
{% load markdown_tags %}
{% load bibtex_tags %}

{% block title %}{{ publication.title }} | Kiri Library{% endblock %}

{% block extra_head %}
{% if publication.executable_script %}
<!-- Pyodide only loaded if script exists -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.27.0/full/pyodide.js"></script>
{% endif %}
<!-- MathJax for LaTeX support -->
<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        svg: {
            fontCache: 'global'
        }
    };
</script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

    <header class="mb-8">
        <div class="flex items-center gap-2 mb-4 text-sm text-text-tertiary dark:text-dark-secondary">
            <a href="{% url 'publications:list' %}" class="hover:text-brand-green transition-colors">
                <i class="fas fa-arrow-left mr-1"></i> Library
            </a>
            <span>/</span>
            <span>{{ publication.created_at|date:"Y" }}</span>
        </div>

        <h1 class="text-4xl md:text-5xl font-display font-bold text-text-primary dark:text-white mb-6 leading-tight">
            {{ publication.title }}
        </h1>

        <div class="flex flex-wrap items-center gap-6 text-sm">
            <div class="flex items-center gap-2">
                {% if publication.author.github_avatar_url %}
                <img src="{{ publication.author.github_avatar_url }}" class="w-8 h-8 rounded-full">
                {% else %}
                <div
                    class="w-8 h-8 rounded-full bg-brand-gold/20 text-brand-gold flex items-center justify-center font-bold">
                    {{ publication.author.username|slice:":1" }}
                </div>
                {% endif %}
                <div>
                    <span class="block text-text-primary dark:text-white font-medium">{{ publication.author.username
                        }}</span>
                    <span class="text-text-tertiary dark:text-dark-secondary">Author</span>
                </div>
            </div>

            <div class="border-l border-border h-8 dark:border-dark-border"></div>

            <div class="flex flex-col">
                <span class="text-text-primary dark:text-white font-medium">{{ publication.created_at|date:"F j, Y"
                    }}</span>
                <span class="text-text-tertiary dark:text-dark-secondary">Version {{ publication.version }}</span>
            </div>

            {% if publication.arxiv_id %}
            <div class="border-l border-border h-8 dark:border-dark-border"></div>
            <a href="https://arxiv.org/abs/{{ publication.arxiv_id }}" target="_blank"
                class="flex items-center gap-1 text-brand-green hover:underline">
                <i class="fas fa-external-link-alt"></i> arXiv:{{ publication.arxiv_id }}
            </a>
            {% endif %}
        </div>

        {% if publication.contributors.exists %}
        <div class="mt-4 flex flex-wrap gap-2 items-center text-sm">
            <span class="text-text-secondary dark:text-dark-secondary">With:</span>
            {% for contributor in publication.contributors.all %}
            <a href="{% url 'users:profile' contributor.username %}"
                class="px-2 py-1 rounded bg-bg-tertiary text-text-primary hover:bg-brand-green/10 transition-colors dark:bg-dark-surface dark:text-dark-text">
                {{ contributor.username }}
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </header>

    <!-- Content -->
    <article class="prose prose-zinc dark:prose-invert max-w-none mb-12">
        {{ publication.content|render_markdown }}
    </article>

    <!-- Executable Code -->
    {% if publication.executable_script %}
    <div
        class="mb-12 rounded-xl border border-border bg-bg-secondary overflow-hidden dark:border-dark-border dark:bg-dark-surface">
        <div
            class="flex items-center justify-between px-4 py-3 border-b border-border bg-bg-tertiary dark:border-dark-border dark:bg-black/20">
            <h3 class="font-mono text-sm font-bold text-text-primary dark:text-white">
                <i class="fab fa-python mr-2 text-brand-gold"></i> Live Demo
            </h3>
            <button id="run-code-btn" class="btn-primary py-1 px-3 text-xs">
                <i class="fas fa-play mr-1"></i> Run Code
            </button>
        </div>
        <div class="relative group">
            <pre
                class="p-4 bg-[#1e1e1e] text-gray-300 text-sm overflow-x-auto"><code>{{ publication.executable_script }}</code></pre>
            <div id="code-overlay"
                class="absolute inset-0 bg-black/50 hidden items-center justify-center backdrop-blur-sm">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
            </div>
        </div>
        <div id="output-area"
            class="p-4 bg-black font-mono text-xs text-brand-green border-t border-border dark:border-dark-border min-h-[100px] hidden">
            <div class="text-gray-500 mb-2">Reference output:</div>
            <pre id="output-content"></pre>
        </div>
    </div>

    <!-- Data for JS -->
    <div id="script-data" data-code="{{ publication.executable_script|escapejs }}"></div>
    {% endif %}

    <!-- BibTeX -->
    <div
        class="bg-bg-secondary p-6 rounded-xl border border-border dark:bg-dark-surface dark:border-dark-border mb-12 print:hidden">
        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
            <i class="fas fa-quote-right text-brand-gold"></i> Cite this work
        </h3>
        <pre
            class="bg-bg-primary p-4 rounded-lg text-xs font-mono overflow-x-auto text-text-secondary select-all dark:bg-black/30 dark:text-dark-secondary border border-border dark:border-dark-border">@article{kiri_{{ publication.id }},
  title = { {{ publication.title|bibtex_escape }} },
  author = { {{ publication.author.username|bibtex_escape }} },
  journal = { Kiri Research Labs },
  year = { {{ publication.created_at|date:"Y" }} },
  url = { {{ request.build_absolute_uri }} }
}</pre>
    </div>

    <!-- Print-only footer -->
    <div class="hidden print:block mt-8 pt-4 border-t border-gray-300 text-xs text-gray-500">
        <p>Printed from Kiri Research Labs - {{ request.build_absolute_uri }}</p>
        <p>&copy; {% now "Y" %} {{ publication.author.username }}</p>
    </div>

    <!-- Discussion -->
    <div class="print:hidden">
        {% include "core/partials/comments_section.html" with comments=comments object=publication %}
    </div>
    {% if publication.executable_script %}
    <div class="my-8">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-bold uppercase tracking-wider text-text-secondary dark:text-dark-secondary">
                Interactive Demo</h3>
            <span class="text-xs text-brand-green"><i class="fas fa-play-circle"></i> Live Execution</span>
        </div>
        <div
            class="rounded-lg border border-border overflow-hidden bg-bg-secondary dark:bg-dark-surface dark:border-dark-border">
            <div
                class="bg-gray-900 text-gray-400 text-xs px-4 py-2 font-mono border-b border-gray-800 flex justify-between">
                <span>main.py</span>
                <span>Python 3.11 (Pyodide)</span>
            </div>
            <pre
                class="p-4 overflow-x-auto text-sm font-mono text-text-primary dark:text-white"><code>{{ publication.executable_script }}</code></pre>

            <!-- Execution Output -->
            <div id="exec-output-{{ publication.id }}"
                class="bg-black text-green-400 font-mono text-xs p-4 border-t border-gray-800 hidden empty:hidden">
            </div>

            <div
                class="p-4 border-t border-border bg-white dark:bg-dark-bg dark:border-dark-border flex justify-between items-center">
                <span id="pyodide-status" class="text-xs text-text-tertiary">Kernel Idle</span>
                <button class="btn-primary text-xs run-python-btn"
                    data-code="{{ publication.executable_script|escapejs }}"
                    data-output="exec-output-{{ publication.id }}"
                    onclick="document.getElementById('exec-output-{{ publication.id }}').classList.remove('hidden')">
                    <i class="fas fa-play"></i> Run Code
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Discussion -->
    {% include "core/partials/comments_section.html" with comments=comments object=publication %}

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pyodide_runner.js' %}"></script>
{% endblock %}