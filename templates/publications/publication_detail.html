{% extends "base.html" %}
{% load static %}
{% load core_tags %}

{% block title %}{{ publication.title }} | Kiri Library{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">

    <!-- Header -->
    <div class="mb-8 border-b border-border pb-8 dark:border-dark-border">
        <h1 class="text-3xl md:text-4xl font-display font-bold text-text-primary dark:text-white mb-4 leading-tight">
            {{ publication.title }}
        </h1>

        <div class="flex flex-wrap items-center gap-4 text-sm text-text-secondary dark:text-dark-secondary mb-6">
            <a href="{% url 'users:profile' publication.author.username %}"
                class="flex items-center gap-2 hover:text-text-primary dark:hover:text-white transition-colors">
                <div
                    class="w-6 h-6 rounded-full bg-brand text-white flex items-center justify-center text-xs dark:bg-dark-border">
                    {% if publication.author.github_avatar_url %}
                    <img src="{{ publication.author.github_avatar_url }}" class="w-full h-full rounded-full">
                    {% else %}
                    {{ publication.author.username|slice:":1"|upper }}
                    {% endif %}
                </div>
                <span class="font-medium">{{ publication.author.username }}</span>
            </a>
            <span class="text-text-tertiary">•</span>
            <span>{{ publication.created_at|date:"F j, Y" }}</span>
            <span class="text-text-tertiary">•</span>
            <span class="font-mono text-xs bg-bg-tertiary px-2 py-0.5 rounded dark:bg-dark-surface">v{{
                publication.version }}</span>
            <!-- BibTeX Action -->
            <button onclick="document.getElementById('bibtex-modal').classList.remove('hidden')"
                class="ml-auto flex items-center gap-1 text-xs font-bold text-text-tertiary hover:text-text-primary dark:hover:text-white transition-colors">
                <i class="fas fa-quote-right"></i> Cite
            </button>
        </div>

        <div
            class="p-4 bg-bg-secondary rounded-lg border-l-4 border-brand-gold italic text-text-secondary dark:bg-dark-surface dark:text-dark-secondary">
            {{ publication.abstract }}
        </div>

        <!-- BibTeX Modal (Simple) -->
        <div id="bibtex-modal"
            class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4"
            onclick="if(event.target === this) this.classList.add('hidden')">
            <div
                class="bg-white dark:bg-dark-surface w-full max-w-lg rounded-xl shadow-2xl overflow-hidden border border-border dark:border-dark-border">
                <div
                    class="p-4 border-b border-border dark:border-dark-border flex justify-between items-center bg-bg-secondary dark:bg-dark-bg">
                    <h3 class="font-bold text-sm">BibTeX Citation</h3>
                    <button onclick="document.getElementById('bibtex-modal').classList.add('hidden')"
                        class="text-text-tertiary hover:text-text-primary dark:hover:text-white"><i
                            class="fas fa-times"></i></button>
                </div>
                <div class="p-4">
                    <pre
                        class="bg-gray-100 dark:bg-gray-900 p-3 rounded text-xs font-mono overflow-auto text-gray-800 dark:text-gray-300 select-all">@article{kiri_{{ publication.id }},
  title = { {{ publication.title }} },
  author = { {{ publication.author.username }} },
  journal = { Kiri Research Labs },
  year = { {{ publication.created_at|date:"Y" }} },
  url = { {{ request.build_absolute_uri }} }
}</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content (Markdown Rendered) -->
    <article class="prose prose-zinc dark:prose-invert max-w-none mb-12">
        <!-- Allows HTML for now, until secure markdown filter is added. 
             If sticking to raw, linebreaks is safer but ugly. 
             Using 'safe' for now assuming trusted authors (researchers). 
             Future TODO: Use markdown filter. -->
        {{ publication.content|linebreaks }}
    </article>

    <!-- Executable Code Block (If exists) -->
    {% if publication.executable_script %}
    <div class="my-8">
        <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-bold uppercase tracking-wider text-text-secondary dark:text-dark-secondary">
                Interactive Demo</h3>
            <span class="text-xs text-brand-green"><i class="fas fa-play-circle"></i> Live Execution</span>
        </div>
        <div
            class="rounded-lg border border-border overflow-hidden bg-bg-secondary dark:bg-dark-surface dark:border-dark-border">
            <div
                class="bg-gray-900 text-gray-400 text-xs px-4 py-2 font-mono border-b border-gray-800 flex justify-between">
                <span>main.py</span>
                <span>Python 3.11 (Pyodide)</span>
            </div>
            <pre
                class="p-4 overflow-x-auto text-sm font-mono text-text-primary dark:text-white"><code>{{ publication.executable_script }}</code></pre>

            <!-- Execution Output -->
            <div id="exec-output-{{ publication.id }}"
                class="bg-black text-green-400 font-mono text-xs p-4 border-t border-gray-800 hidden empty:hidden">
            </div>

            <div
                class="p-4 border-t border-border bg-white dark:bg-dark-bg dark:border-dark-border flex justify-between items-center">
                <span id="pyodide-status" class="text-xs text-text-tertiary">Kernel Idle</span>
                <button class="btn-primary text-xs run-python-btn"
                    data-code="{{ publication.executable_script|escapejs }}"
                    data-output="exec-output-{{ publication.id }}"
                    onclick="document.getElementById('exec-output-{{ publication.id }}').classList.remove('hidden')">
                    <i class="fas fa-play"></i> Run Code
                </button>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Discussion -->
    {% include "core/partials/comments_section.html" with comments=comments object=publication %}

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pyodide_runner.js' %}"></script>
{% endblock %}